(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const p of l.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&n(p)}).observe(document,{childList:!0,subtree:!0});function o(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(s){if(s.ep)return;s.ep=!0;const l=o(s);fetch(s.href,l)}})();const c={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"bc4a52ed-4eb4-47b2-8325-b0e84b6ab8de","Content-Type":"application/json"}},v=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),M=()=>fetch(`${c.baseUrl}/users/me`,{headers:c.headers}).then(v),A=()=>fetch(`${c.baseUrl}/cards`,{headers:c.headers}).then(v),E=({name:e,about:t})=>fetch(`${c.baseUrl}/users/me`,{method:"PATCH",headers:c.headers,body:JSON.stringify({name:e,about:t})}).then(v),B=e=>fetch(`${c.baseUrl}/users/me/avatar`,{method:"PATCH",headers:c.headers,body:JSON.stringify({avatar:e})}).then(v),P=({name:e,link:t})=>fetch(`${c.baseUrl}/cards`,{method:"POST",headers:c.headers,body:JSON.stringify({name:e,link:t})}).then(v),O=e=>fetch(`${c.baseUrl}/cards/${e}`,{method:"DELETE",headers:c.headers}).then(v),U=(e,t)=>fetch(`${c.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:c.headers}).then(v),T=(e,t)=>{e.textContent=t.length},N=(e,t)=>e.some(o=>o._id===t),$=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),k=(e,{onPreviewPicture:t,onLikeIcon:o,onDeleteCard:n,onInfoClick:s})=>{const l=$(),p=l.querySelector(".card__like-button"),d=l.querySelector(".card__control-button_type_delete"),f=l.querySelector(".card__control-button_type_info"),u=l.querySelector(".card__image"),m=l.querySelector(".card__like-count"),C=l.querySelector(".card__title");return u.src=e.link,u.alt=e.name,C.textContent=e.name,e.id&&(l.dataset.cardId=e.id),e.likes&&m&&(m.textContent=e.likes.length),e.likes&&N(e.likes,e.currentUserId)&&p.classList.add("card__like-button_is-active"),e.isOwn===!1&&(d.style.display="none"),s||(f.style.display="none"),o&&e.id&&p.addEventListener("click",()=>o(p,e.id,m)),n&&e.isOwn!==!1&&e.id&&d.addEventListener("click",()=>n(l,e.id)),s&&e.id&&f.addEventListener("click",()=>s(l)),t&&u.addEventListener("click",()=>t({name:e.name,link:e.link})),l},w=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");_(t)}},S=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",w)},_=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",w)},F=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{_(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&_(e)})},b=(e,t,o,n)=>{const s=e.querySelector(`#${t.id}-error`);s&&(t.classList.add(n.inputErrorClass),s.textContent=o,s.classList.add(n.errorClass))},I=(e,t,o)=>{const n=e.querySelector(`#${t.id}-error`);n&&(t.classList.remove(o.inputErrorClass),n.textContent="",n.classList.remove(o.errorClass))},J=(e,t,o)=>{if(t.validity.valid)I(e,t,o);else if(t.validity.patternMismatch){const n=t.dataset.errorMessage||t.validationMessage;b(e,t,n,o)}else b(e,t,t.validationMessage,o)},W=e=>e.some(t=>!t.validity.valid),x=(e,t)=>{e&&(e.classList.add(t.inactiveButtonClass),e.disabled=!0)},H=(e,t)=>{e&&(e.classList.remove(t.inactiveButtonClass),e.disabled=!1)},g=(e,t,o)=>{W(e)?x(t,o):H(t,o)},V=(e,t)=>{const o=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);n&&(g(o,n,t),o.forEach(s=>{s.addEventListener("input",()=>{J(e,s,t),g(o,n,t)})}))},q=(e,t)=>{const o=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);o.forEach(s=>{I(e,s,t)}),n&&x(n,t)},j=e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach(o=>{V(o,e)})},i={validation:{formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},selectors:{placesWrap:".places__list",profile:{title:".profile__title",description:".profile__description",avatar:".profile__image",editButton:".profile__edit-button",addButton:".profile__add-button"},modals:{editProfile:".popup_type_edit",newCard:".popup_type_new-card",image:".popup_type_image",editAvatar:".popup_type_edit-avatar",removeCard:".popup_type_remove-card",info:".popup_type_info"},forms:{profile:".popup__form",card:".popup__form",avatar:".popup__form",removeCard:".popup__form"},inputs:{profile:{name:".popup__input_type_name",description:".popup__input_type_description"},card:{name:".popup__input_type_card-name",link:".popup__input_type_url"},avatar:".popup__input"},imageModal:{image:".popup__image",caption:".popup__caption"},infoModal:{title:".popup__title",infoList:".popup__info",text:".popup__text",userList:".popup__list"}}},r={placesWrap:document.querySelector(i.selectors.placesWrap),profile:{title:document.querySelector(i.selectors.profile.title),description:document.querySelector(i.selectors.profile.description),avatar:document.querySelector(i.selectors.profile.avatar),editButton:document.querySelector(i.selectors.profile.editButton),addButton:document.querySelector(i.selectors.profile.addButton)},modals:{editProfile:document.querySelector(i.selectors.modals.editProfile),newCard:document.querySelector(i.selectors.modals.newCard),image:document.querySelector(i.selectors.modals.image),editAvatar:document.querySelector(i.selectors.modals.editAvatar),removeCard:document.querySelector(i.selectors.modals.removeCard),info:document.querySelector(i.selectors.modals.info)},forms:{profile:{modal:document.querySelector(i.selectors.modals.editProfile),form:document.querySelector(i.selectors.modals.editProfile).querySelector(i.selectors.forms.profile),inputs:{name:document.querySelector(i.selectors.modals.editProfile).querySelector(i.selectors.inputs.profile.name),description:document.querySelector(i.selectors.modals.editProfile).querySelector(i.selectors.inputs.profile.description)}},card:{modal:document.querySelector(i.selectors.modals.newCard),form:document.querySelector(i.selectors.modals.newCard).querySelector(i.selectors.forms.card),inputs:{name:document.querySelector(i.selectors.modals.newCard).querySelector(i.selectors.inputs.card.name),link:document.querySelector(i.selectors.modals.newCard).querySelector(i.selectors.inputs.card.link)}},avatar:{modal:document.querySelector(i.selectors.modals.editAvatar),form:document.querySelector(i.selectors.modals.editAvatar).querySelector(i.selectors.forms.avatar),input:document.querySelector(i.selectors.modals.editAvatar).querySelector(i.selectors.inputs.avatar)},removeCard:{modal:document.querySelector(i.selectors.modals.removeCard),form:document.querySelector(i.selectors.modals.removeCard).querySelector(i.selectors.forms.removeCard),submitButton:document.querySelector(i.selectors.modals.removeCard).querySelector(i.selectors.forms.removeCard+" .popup__button")}},imageModal:{image:document.querySelector(i.selectors.modals.image).querySelector(i.selectors.imageModal.image),caption:document.querySelector(i.selectors.modals.image).querySelector(i.selectors.imageModal.caption)},infoModal:{title:document.querySelector(i.selectors.modals.info).querySelector(i.selectors.infoModal.title),infoList:document.querySelector(i.selectors.modals.info).querySelector(i.selectors.infoModal.infoList),text:document.querySelector(i.selectors.modals.info).querySelector(i.selectors.infoModal.text),userList:document.querySelector(i.selectors.modals.info).querySelector(i.selectors.infoModal.userList)}};let y="",h=null;const R=e=>e.toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"}),L=(e,t)=>{if(!e||!t)return;const o={name:t.name||"",link:t.link||"",likes:t.likes||[],owner:t.owner||{name:"Неизвестно",_id:""},createdAt:t.createdAt||new Date().toISOString(),id:t._id||t.id||"",ownerId:t.owner?._id||t.ownerId||"",currentUserId:y};e.dataset.cardInfo=JSON.stringify(o)},z=(e,t)=>{document.querySelectorAll(".card").forEach(n=>{if(n.dataset.cardInfo)try{const s=JSON.parse(n.dataset.cardInfo);s.likes&&Array.isArray(s.likes)&&s.likes.forEach(l=>{l._id===e&&(l.name=t)}),s.owner&&s.owner._id===e&&(s.owner.name=t),n.dataset.cardInfo=JSON.stringify(s)}catch(s){console.error("Ошибка при обновлении имени пользователя в карточке:",s)}})},a={previewPicture:({name:e,link:t})=>{r.imageModal.image.src=t,r.imageModal.image.alt=e,r.imageModal.caption.textContent=e,S(r.modals.image)},handleLikeCard:(e,t,o)=>{const n=e.classList.contains("card__like-button_is-active");U(t,n).then(s=>{e.classList.toggle("card__like-button_is-active"),o&&T(o,s.likes);const l=e.closest(".card");l&&L(l,s)}).catch(s=>{console.log("Ошибка при изменении лайка:",s)})},prepareCardDelete:(e,t)=>{h={element:e,id:t},S(r.modals.removeCard)},handleCardDelete:e=>{e.preventDefault();const t=e.submitter||r.forms.removeCard.submitButton,o=t.textContent;t.textContent="Удаление...",O(h.id).then(()=>{h.element.remove(),_(r.modals.removeCard),h=null}).catch(n=>{console.log("Ошибка при удалении:",n)}).finally(()=>{t.textContent=o})},handleCardInfo:e=>{let t;if(e&&e.dataset.cardInfo)try{t=JSON.parse(e.dataset.cardInfo)}catch(o){console.error("Ошибка при парсинге данных карточки:",o);return}else{console.error("Нет данных карточки в DOM");return}if(!t||!t.name&&!t.id){console.error("Card data missing required fields:",t);return}try{if(!r.infoModal.title||!r.infoModal.infoList||!r.infoModal.userList||!r.infoModal.text){console.error("Не все DOM-элементы для информации о карточке найдены");return}r.infoModal.infoList.innerHTML="",r.infoModal.userList.innerHTML="",r.infoModal.title.textContent=t.name||"Без названия";const o=document.getElementById("popup-info-definition-template"),n=document.getElementById("popup-info-user-preview-template");if(!o||!n){console.error("Шаблоны для информации о карточке не найдены");return}const s=(d,f)=>{const u=o.content.cloneNode(!0),m=u.querySelector(".popup__info-term"),C=u.querySelector(".popup__info-description");m&&C&&(m.textContent=d,C.textContent=f!=null?String(f):"",r.infoModal.infoList.appendChild(u))};if(s("Название:",t.name||"Без названия"),t.createdAt)try{s("Дата создания:",R(new Date(t.createdAt)))}catch(d){console.error("Ошибка при форматировании даты:",d),s("Дата создания:","Неизвестно")}const l=t.owner&&t.owner.name?t.owner.name:"Неизвестно";s("Владелец:",l);const p=t.likes&&Array.isArray(t.likes)?t.likes.length:0;s("Количество лайков:",p),r.infoModal.text.textContent="Пользователи, поставившие лайк:",t.likes&&Array.isArray(t.likes)&&t.likes.forEach(d=>{const f=d&&d.name?d.name:"Неизвестный пользователь",u=n.content.cloneNode(!0),m=u.querySelector(".popup__list-item");m&&(m.textContent=f,r.infoModal.userList.appendChild(u))}),S(r.modals.info)}catch(o){console.error("Ошибка при отображении информации о карточке:",o)}},profileFormSubmit:e=>{e.preventDefault();const t=e.submitter,o=t.textContent;t.textContent="Сохранение...",E({name:r.forms.profile.inputs.name.value,about:r.forms.profile.inputs.description.value}).then(n=>{const s=n.name;r.profile.title.textContent=s,r.profile.description.textContent=n.about,y&&z(y,s),_(r.forms.profile.modal),r.forms.profile.form.reset()}).catch(n=>{console.log("Ошибка при обновлении профиля:",n)}).finally(()=>{t.textContent=o})},avatarFormSubmit:e=>{e.preventDefault();const t=e.submitter,o=t.textContent;t.textContent="Сохранение...",B(r.forms.avatar.input.value).then(n=>{r.profile.avatar.style.backgroundImage=`url(${n.avatar})`,_(r.forms.avatar.modal),r.forms.avatar.form.reset()}).catch(n=>{console.log("Ошибка при обновлении аватара:",n)}).finally(()=>{t.textContent=o})},cardFormSubmit:e=>{e.preventDefault();const t=e.submitter,o=t.textContent;t.textContent="Создание...",P({name:r.forms.card.inputs.name.value,link:r.forms.card.inputs.link.value}).then(n=>{const s=k({name:n.name,link:n.link,likes:n.likes,id:n._id,owner:n.owner,ownerId:n.owner._id,isOwn:n.owner._id===y,currentUserId:y,createdAt:n.createdAt},{onPreviewPicture:a.previewPicture,onLikeIcon:a.handleLikeCard,onDeleteCard:a.prepareCardDelete,onInfoClick:a.handleCardInfo});L(s,n),r.placesWrap.prepend(s),_(r.forms.card.modal),r.forms.card.form.reset()}).catch(n=>{console.log("Ошибка при добавлении карточки:",n)}).finally(()=>{t.textContent=o})},openProfileForm:()=>{r.forms.profile.inputs.name.value=r.profile.title.textContent,r.forms.profile.inputs.description.value=r.profile.description.textContent,S(r.forms.profile.modal),q(r.forms.profile.form,i.validation)},openAvatarForm:()=>{r.forms.avatar.form.reset(),S(r.forms.avatar.modal),q(r.forms.avatar.form,i.validation)},openCardForm:()=>{r.forms.card.form.reset(),S(r.forms.card.modal),q(r.forms.card.form,i.validation)}},D=()=>{r.forms.profile.form.addEventListener("submit",a.profileFormSubmit),r.forms.card.form.addEventListener("submit",a.cardFormSubmit),r.forms.avatar.form.addEventListener("submit",a.avatarFormSubmit),r.forms.removeCard.form.addEventListener("submit",a.handleCardDelete),r.profile.editButton.addEventListener("click",a.openProfileForm),r.profile.avatar.addEventListener("click",a.openAvatarForm),r.profile.addButton.addEventListener("click",a.openCardForm),document.querySelectorAll(".popup").forEach(t=>{F(t)})},K=()=>{j(i.validation)},G=()=>{D(),K()};document.addEventListener("DOMContentLoaded",()=>{G(),Promise.all([A(),M()]).then(([e,t])=>{y=t._id,t.name,r.profile.title.textContent=t.name,r.profile.description.textContent=t.about,r.profile.avatar.style.backgroundImage=`url(${t.avatar})`,r.placesWrap.innerHTML="",e.forEach(o=>{const n=k({name:o.name,link:o.link,likes:o.likes,id:o._id,owner:o.owner,ownerId:o.owner._id,isOwn:o.owner._id===y,currentUserId:y,createdAt:o.createdAt},{onPreviewPicture:a.previewPicture,onLikeIcon:a.handleLikeCard,onDeleteCard:a.prepareCardDelete,onInfoClick:a.handleCardInfo});L(n,o),r.placesWrap.append(n)})}).catch(e=>{console.log("Ошибка при загрузке данных:",e)})});

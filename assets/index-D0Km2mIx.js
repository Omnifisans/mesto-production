(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const d of l.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&n(d)}).observe(document,{childList:!0,subtree:!0});function s(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(i){if(i.ep)return;i.ep=!0;const l=s(i);fetch(i.href,l)}})();const c={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"bc4a52ed-4eb4-47b2-8325-b0e84b6ab8de","Content-Type":"application/json"}},p=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),M=()=>fetch(`${c.baseUrl}/users/me`,{headers:c.headers}).then(p),B=()=>fetch(`${c.baseUrl}/cards`,{headers:c.headers}).then(p),I=({name:e,about:t})=>fetch(`${c.baseUrl}/users/me`,{method:"PATCH",headers:c.headers,body:JSON.stringify({name:e,about:t})}).then(p),w=e=>fetch(`${c.baseUrl}/users/me/avatar`,{method:"PATCH",headers:c.headers,body:JSON.stringify({avatar:e})}).then(p),P=({name:e,link:t})=>fetch(`${c.baseUrl}/cards`,{method:"POST",headers:c.headers,body:JSON.stringify({name:e,link:t})}).then(p),A=e=>fetch(`${c.baseUrl}/cards/${e}`,{method:"DELETE",headers:c.headers}).then(p),T=(e,t)=>fetch(`${c.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:c.headers}).then(p),U=(e,t)=>{e.textContent=t.length},O=(e,t)=>e.some(s=>s._id===t),$=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),b=(e,{onPreviewPicture:t,onLikeIcon:s,onDeleteCard:n,onInfoClick:i})=>{const l=$(),d=l.querySelector(".card__like-button"),C=l.querySelector(".card__control-button_type_delete"),h=l.querySelector(".card__control-button_type_info"),y=l.querySelector(".card__image"),v=l.querySelector(".card__like-count"),E=l.querySelector(".card__title");return y.src=e.link,y.alt=e.name,E.textContent=e.name,e.id&&(l.dataset.cardId=e.id),e.likes&&v&&(v.textContent=e.likes.length),e.likes&&O(e.likes,e.currentUserId)&&d.classList.add("card__like-button_is-active"),e.isOwn===!1&&(C.style.display="none"),i||(h.style.display="none"),s&&e.id&&d.addEventListener("click",()=>s(d,e.id,v)),n&&e.isOwn!==!1&&e.id&&C.addEventListener("click",()=>n(l,e.id)),i&&e.id&&h.addEventListener("click",()=>i(e)),t&&y.addEventListener("click",()=>t({name:e.name,link:e.link})),l},g=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");u(t)}},m=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",g)},u=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",g)},F=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{u(e)}),e.addEventListener("mousedown",s=>{s.target.classList.contains("popup")&&u(e)})},q=(e,t,s,n)=>{const i=e.querySelector(`#${t.id}-error`);i&&(t.classList.add(n.inputErrorClass),i.textContent=s,i.classList.add(n.errorClass))},k=(e,t,s)=>{const n=e.querySelector(`#${t.id}-error`);n&&(t.classList.remove(s.inputErrorClass),n.textContent="",n.classList.remove(s.errorClass))},N=(e,t,s)=>{if(t.validity.valid)k(e,t,s);else if(t.validity.patternMismatch){const n=t.dataset.errorMessage||t.validationMessage;q(e,t,n,s)}else q(e,t,t.validationMessage,s)},W=e=>e.some(t=>!t.validity.valid),x=(e,t)=>{e&&(e.classList.add(t.inactiveButtonClass),e.disabled=!0)},H=(e,t)=>{e&&(e.classList.remove(t.inactiveButtonClass),e.disabled=!1)},L=(e,t,s)=>{W(e)?x(t,s):H(t,s)},V=(e,t)=>{const s=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);n&&(L(s,n,t),s.forEach(i=>{i.addEventListener("input",()=>{N(e,i,t),L(s,n,t)})}))},S=(e,t)=>{const s=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);s.forEach(i=>{k(e,i,t)}),n&&x(n,t)},j=e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach(s=>{V(s,e)})},r={validation:{formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},selectors:{placesWrap:".places__list",profile:{title:".profile__title",description:".profile__description",avatar:".profile__image",editButton:".profile__edit-button",addButton:".profile__add-button"},modals:{editProfile:".popup_type_edit",newCard:".popup_type_new-card",image:".popup_type_image",editAvatar:".popup_type_edit-avatar",removeCard:".popup_type_remove-card",info:".popup_type_info"},forms:{profile:".popup__form",card:".popup__form",avatar:".popup__form",removeCard:".popup__form"},inputs:{profile:{name:".popup__input_type_name",description:".popup__input_type_description"},card:{name:".popup__input_type_card-name",link:".popup__input_type_url"},avatar:".popup__input"},imageModal:{image:".popup__image",caption:".popup__caption"},infoModal:{title:".popup__title",infoList:".popup__info",text:".popup__text",userList:".popup__list"}}},o={placesWrap:document.querySelector(r.selectors.placesWrap),profile:{title:document.querySelector(r.selectors.profile.title),description:document.querySelector(r.selectors.profile.description),avatar:document.querySelector(r.selectors.profile.avatar),editButton:document.querySelector(r.selectors.profile.editButton),addButton:document.querySelector(r.selectors.profile.addButton)},modals:{editProfile:document.querySelector(r.selectors.modals.editProfile),newCard:document.querySelector(r.selectors.modals.newCard),image:document.querySelector(r.selectors.modals.image),editAvatar:document.querySelector(r.selectors.modals.editAvatar),removeCard:document.querySelector(r.selectors.modals.removeCard),info:document.querySelector(r.selectors.modals.info)},forms:{profile:{modal:document.querySelector(r.selectors.modals.editProfile),form:document.querySelector(r.selectors.modals.editProfile).querySelector(r.selectors.forms.profile),inputs:{name:document.querySelector(r.selectors.modals.editProfile).querySelector(r.selectors.inputs.profile.name),description:document.querySelector(r.selectors.modals.editProfile).querySelector(r.selectors.inputs.profile.description)}},card:{modal:document.querySelector(r.selectors.modals.newCard),form:document.querySelector(r.selectors.modals.newCard).querySelector(r.selectors.forms.card),inputs:{name:document.querySelector(r.selectors.modals.newCard).querySelector(r.selectors.inputs.card.name),link:document.querySelector(r.selectors.modals.newCard).querySelector(r.selectors.inputs.card.link)}},avatar:{modal:document.querySelector(r.selectors.modals.editAvatar),form:document.querySelector(r.selectors.modals.editAvatar).querySelector(r.selectors.forms.avatar),input:document.querySelector(r.selectors.modals.editAvatar).querySelector(r.selectors.inputs.avatar)},removeCard:{modal:document.querySelector(r.selectors.modals.removeCard),form:document.querySelector(r.selectors.modals.removeCard).querySelector(r.selectors.forms.removeCard),submitButton:document.querySelector(r.selectors.modals.removeCard).querySelector(r.selectors.forms.removeCard+" .popup__button")}},imageModal:{image:document.querySelector(r.selectors.modals.image).querySelector(r.selectors.imageModal.image),caption:document.querySelector(r.selectors.modals.image).querySelector(r.selectors.imageModal.caption)},infoModal:{title:document.querySelector(r.selectors.modals.info).querySelector(r.selectors.infoModal.title),infoList:document.querySelector(r.selectors.modals.info).querySelector(r.selectors.infoModal.infoList),text:document.querySelector(r.selectors.modals.info).querySelector(r.selectors.infoModal.text),userList:document.querySelector(r.selectors.modals.info).querySelector(r.selectors.infoModal.userList)}};let f="",_=null;const D=e=>e.toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"}),a={previewPicture:({name:e,link:t})=>{o.imageModal.image.src=t,o.imageModal.image.alt=e,o.imageModal.caption.textContent=e,m(o.modals.image)},handleLikeCard:(e,t,s)=>{const n=e.classList.contains("card__like-button_is-active");T(t,n).then(i=>{e.classList.toggle("card__like-button_is-active"),s&&U(s,i.likes)}).catch(i=>{console.log("Ошибка при изменении лайка:",i)})},prepareCardDelete:(e,t)=>{_={element:e,id:t},m(o.modals.removeCard)},handleCardDelete:e=>{e.preventDefault();const t=e.submitter||o.forms.removeCard.submitButton,s=t.textContent;t.textContent="Удаление...",A(_.id).then(()=>{_.element.remove(),u(o.modals.removeCard),_=null}).catch(n=>{console.log("Ошибка при удалении:",n)}).finally(()=>{t.textContent=s})},handleCardInfo:e=>{o.infoModal.infoList.innerHTML="",o.infoModal.userList.innerHTML="",o.infoModal.title.textContent=e.name;const t=document.getElementById("popup-info-definition-template"),s=document.getElementById("popup-info-user-preview-template"),n=(i,l)=>{const d=t.content.cloneNode(!0);d.querySelector(".popup__info-term").textContent=i,d.querySelector(".popup__info-description").textContent=l,o.infoModal.infoList.appendChild(d)};n("Описание:",e.name),n("Дата создания:",D(new Date(e.createdAt))),n("Владелец:",e.owner.name),n("Количество лайков:",e.likes.length),o.infoModal.text.textContent="Пользователи, поставившие лайк:",e.likes.forEach(i=>{const l=s.content.cloneNode(!0);l.querySelector(".popup__list-item").textContent=i.name,o.infoModal.userList.appendChild(l)}),m(o.modals.info)},profileFormSubmit:e=>{e.preventDefault();const t=e.submitter,s=t.textContent;t.textContent="Сохранение...",I({name:o.forms.profile.inputs.name.value,about:o.forms.profile.inputs.description.value}).then(n=>{o.profile.title.textContent=n.name,o.profile.description.textContent=n.about,u(o.forms.profile.modal),o.forms.profile.form.reset()}).catch(n=>{console.log("Ошибка при обновлении профиля:",n)}).finally(()=>{t.textContent=s})},avatarFormSubmit:e=>{e.preventDefault();const t=e.submitter,s=t.textContent;t.textContent="Сохранение...",w(o.forms.avatar.input.value).then(n=>{o.profile.avatar.style.backgroundImage=`url(${n.avatar})`,u(o.forms.avatar.modal),o.forms.avatar.form.reset()}).catch(n=>{console.log("Ошибка при обновлении аватара:",n)}).finally(()=>{t.textContent=s})},cardFormSubmit:e=>{e.preventDefault();const t=e.submitter,s=t.textContent;t.textContent="Создание...",P({name:o.forms.card.inputs.name.value,link:o.forms.card.inputs.link.value}).then(n=>{const i=b({name:n.name,link:n.link,likes:n.likes,id:n._id,ownerId:n.owner._id,isOwn:n.owner._id===f,currentUserId:f,createdAt:n.createdAt},{onPreviewPicture:a.previewPicture,onLikeIcon:a.handleLikeCard,onDeleteCard:a.prepareCardDelete,onInfoClick:a.handleCardInfo});o.placesWrap.prepend(i),u(o.forms.card.modal),o.forms.card.form.reset()}).catch(n=>{console.log("Ошибка при добавлении карточки:",n)}).finally(()=>{t.textContent=s})},openProfileForm:()=>{o.forms.profile.inputs.name.value=o.profile.title.textContent,o.forms.profile.inputs.description.value=o.profile.description.textContent,m(o.forms.profile.modal),S(o.forms.profile.form,r.validation)},openAvatarForm:()=>{o.forms.avatar.form.reset(),m(o.forms.avatar.modal),S(o.forms.avatar.form,r.validation)},openCardForm:()=>{o.forms.card.form.reset(),m(o.forms.card.modal),S(o.forms.card.form,r.validation)}},J=()=>{o.forms.profile.form.addEventListener("submit",a.profileFormSubmit),o.forms.card.form.addEventListener("submit",a.cardFormSubmit),o.forms.avatar.form.addEventListener("submit",a.avatarFormSubmit),o.forms.removeCard.form.addEventListener("submit",a.handleCardDelete),o.profile.editButton.addEventListener("click",a.openProfileForm),o.profile.avatar.addEventListener("click",a.openAvatarForm),o.profile.addButton.addEventListener("click",a.openCardForm),document.querySelectorAll(".popup").forEach(t=>{F(t)})},R=()=>{j(r.validation)},z=()=>{J(),R()};document.addEventListener("DOMContentLoaded",()=>{z(),Promise.all([B(),M()]).then(([e,t])=>{f=t._id,o.profile.title.textContent=t.name,o.profile.description.textContent=t.about,o.profile.avatar.style.backgroundImage=`url(${t.avatar})`,o.placesWrap.innerHTML="",e.forEach(s=>{const n=b({name:s.name,link:s.link,likes:s.likes,id:s._id,ownerId:s.owner._id,isOwn:s.owner._id===f,currentUserId:f,createdAt:s.createdAt},{onPreviewPicture:a.previewPicture,onLikeIcon:a.handleLikeCard,onDeleteCard:a.prepareCardDelete,onInfoClick:a.handleCardInfo});o.placesWrap.append(n)})}).catch(e=>{console.log("Ошибка при загрузке данных:",e)})});

(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const d of l.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&r(d)}).observe(document,{childList:!0,subtree:!0});function s(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function r(i){if(i.ep)return;i.ep=!0;const l=s(i);fetch(i.href,l)}})();const c={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"bc4a52ed-4eb4-47b2-8325-b0e84b6ab8de","Content-Type":"application/json"}},f=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),w=()=>fetch(`${c.baseUrl}/users/me`,{headers:c.headers}).then(f),E=()=>fetch(`${c.baseUrl}/cards`,{headers:c.headers}).then(f),A=({name:e,about:t})=>fetch(`${c.baseUrl}/users/me`,{method:"PATCH",headers:c.headers,body:JSON.stringify({name:e,about:t})}).then(f),I=e=>fetch(`${c.baseUrl}/users/me/avatar`,{method:"PATCH",headers:c.headers,body:JSON.stringify({avatar:e})}).then(f),B=({name:e,link:t})=>fetch(`${c.baseUrl}/cards`,{method:"POST",headers:c.headers,body:JSON.stringify({name:e,link:t})}).then(f),P=e=>fetch(`${c.baseUrl}/cards/${e}`,{method:"DELETE",headers:c.headers}).then(f),T=(e,t)=>fetch(`${c.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:c.headers}).then(f),U=(e,t)=>{e.textContent=t.length},O=(e,t)=>e.some(s=>s._id===t),$=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),b=(e,{onPreviewPicture:t,onLikeIcon:s,onDeleteCard:r,onInfoClick:i})=>{const l=$(),d=l.querySelector(".card__like-button"),y=l.querySelector(".card__control-button_type_delete"),u=l.querySelector(".card__control-button_type_info"),p=l.querySelector(".card__image"),_=l.querySelector(".card__like-count"),M=l.querySelector(".card__title");return p.src=e.link,p.alt=e.name,M.textContent=e.name,e.id&&(l.dataset.cardId=e.id),e.likes&&_&&(_.textContent=e.likes.length),e.likes&&O(e.likes,e.currentUserId)&&d.classList.add("card__like-button_is-active"),e.isOwn===!1&&(y.style.display="none"),i||(u.style.display="none"),s&&e.id&&d.addEventListener("click",()=>s(d,e.id,_)),r&&e.isOwn!==!1&&e.id&&y.addEventListener("click",()=>r(l,e.id)),i&&e.id&&u.addEventListener("click",()=>i(e)),t&&p.addEventListener("click",()=>t({name:e.name,link:e.link})),l},g=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");m(t)}},v=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",g)},m=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",g)},F=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{m(e)}),e.addEventListener("mousedown",s=>{s.target.classList.contains("popup")&&m(e)})},q=(e,t,s,r)=>{const i=e.querySelector(`#${t.id}-error`);i&&(t.classList.add(r.inputErrorClass),i.textContent=s,i.classList.add(r.errorClass))},k=(e,t,s)=>{const r=e.querySelector(`#${t.id}-error`);r&&(t.classList.remove(s.inputErrorClass),r.textContent="",r.classList.remove(s.errorClass))},N=(e,t,s)=>{if(t.validity.valid)k(e,t,s);else if(t.validity.patternMismatch){const r=t.dataset.errorMessage||t.validationMessage;q(e,t,r,s)}else q(e,t,t.validationMessage,s)},W=e=>e.some(t=>!t.validity.valid),x=(e,t)=>{e&&(e.classList.add(t.inactiveButtonClass),e.disabled=!0)},H=(e,t)=>{e&&(e.classList.remove(t.inactiveButtonClass),e.disabled=!1)},L=(e,t,s)=>{W(e)?x(t,s):H(t,s)},V=(e,t)=>{const s=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);r&&(L(s,r,t),s.forEach(i=>{i.addEventListener("input",()=>{N(e,i,t),L(s,r,t)})}))},h=(e,t)=>{const s=Array.from(e.querySelectorAll(t.inputSelector)),r=e.querySelector(t.submitButtonSelector);s.forEach(i=>{k(e,i,t)}),r&&x(r,t)},j=e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach(s=>{V(s,e)})},n={validation:{formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},selectors:{placesWrap:".places__list",profile:{title:".profile__title",description:".profile__description",avatar:".profile__image",editButton:".profile__edit-button",addButton:".profile__add-button"},modals:{editProfile:".popup_type_edit",newCard:".popup_type_new-card",image:".popup_type_image",editAvatar:".popup_type_edit-avatar",removeCard:".popup_type_remove-card",info:".popup_type_info"},forms:{profile:".popup__form",card:".popup__form",avatar:".popup__form",removeCard:".popup__form"},inputs:{profile:{name:".popup__input_type_name",description:".popup__input_type_description"},card:{name:".popup__input_type_card-name",link:".popup__input_type_url"},avatar:".popup__input"},imageModal:{image:".popup__image",caption:".popup__caption"},infoModal:{title:".popup__title",infoList:".popup__info",text:".popup__text",userList:".popup__list"}}},o={placesWrap:document.querySelector(n.selectors.placesWrap),profile:{title:document.querySelector(n.selectors.profile.title),description:document.querySelector(n.selectors.profile.description),avatar:document.querySelector(n.selectors.profile.avatar),editButton:document.querySelector(n.selectors.profile.editButton),addButton:document.querySelector(n.selectors.profile.addButton)},modals:{editProfile:document.querySelector(n.selectors.modals.editProfile),newCard:document.querySelector(n.selectors.modals.newCard),image:document.querySelector(n.selectors.modals.image),editAvatar:document.querySelector(n.selectors.modals.editAvatar),removeCard:document.querySelector(n.selectors.modals.removeCard),info:document.querySelector(n.selectors.modals.info)},forms:{profile:{modal:document.querySelector(n.selectors.modals.editProfile),form:document.querySelector(n.selectors.modals.editProfile).querySelector(n.selectors.forms.profile),inputs:{name:document.querySelector(n.selectors.modals.editProfile).querySelector(n.selectors.inputs.profile.name),description:document.querySelector(n.selectors.modals.editProfile).querySelector(n.selectors.inputs.profile.description)}},card:{modal:document.querySelector(n.selectors.modals.newCard),form:document.querySelector(n.selectors.modals.newCard).querySelector(n.selectors.forms.card),inputs:{name:document.querySelector(n.selectors.modals.newCard).querySelector(n.selectors.inputs.card.name),link:document.querySelector(n.selectors.modals.newCard).querySelector(n.selectors.inputs.card.link)}},avatar:{modal:document.querySelector(n.selectors.modals.editAvatar),form:document.querySelector(n.selectors.modals.editAvatar).querySelector(n.selectors.forms.avatar),input:document.querySelector(n.selectors.modals.editAvatar).querySelector(n.selectors.inputs.avatar)},removeCard:{modal:document.querySelector(n.selectors.modals.removeCard),form:document.querySelector(n.selectors.modals.removeCard).querySelector(n.selectors.forms.removeCard),submitButton:document.querySelector(n.selectors.modals.removeCard).querySelector(n.selectors.forms.removeCard+" .popup__button")}},imageModal:{image:document.querySelector(n.selectors.modals.image).querySelector(n.selectors.imageModal.image),caption:document.querySelector(n.selectors.modals.image).querySelector(n.selectors.imageModal.caption)},infoModal:{title:document.querySelector(n.selectors.modals.info).querySelector(n.selectors.infoModal.title),infoList:document.querySelector(n.selectors.modals.info).querySelector(n.selectors.infoModal.infoList),text:document.querySelector(n.selectors.modals.info).querySelector(n.selectors.infoModal.text),userList:document.querySelector(n.selectors.modals.info).querySelector(n.selectors.infoModal.userList)}};let S="",C=null;const J=e=>e.toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"}),a={previewPicture:({name:e,link:t})=>{o.imageModal.image.src=t,o.imageModal.image.alt=e,o.imageModal.caption.textContent=e,v(o.modals.image)},handleLikeCard:(e,t,s)=>{const r=e.classList.contains("card__like-button_is-active");T(t,r).then(i=>{e.classList.toggle("card__like-button_is-active"),s&&U(s,i.likes)}).catch(i=>{console.log("Ошибка при изменении лайка:",i)})},prepareCardDelete:(e,t)=>{C={element:e,id:t},v(o.modals.removeCard)},handleCardDelete:e=>{e.preventDefault();const t=e.submitter||o.forms.removeCard.submitButton,s=t.textContent;t.textContent="Удаление...",P(C.id).then(()=>{C.element.remove(),m(o.modals.removeCard),C=null}).catch(r=>{console.log("Ошибка при удалении:",r)}).finally(()=>{t.textContent=s})},handleCardInfo:e=>{try{if(!e){console.error("Данные карточки не переданы");return}if(!o.infoModal.title||!o.infoModal.infoList||!o.infoModal.userList||!o.infoModal.text){console.error("Не все DOM-элементы для информации о карточке найдены");return}o.infoModal.infoList.innerHTML="",o.infoModal.userList.innerHTML="",o.infoModal.title.textContent=e.name||"Без названия";const t=document.getElementById("popup-info-definition-template"),s=document.getElementById("popup-info-user-preview-template");if(!t||!s){console.error("Шаблоны для информации о карточке не найдены");return}const r=(d,y)=>{const u=t.content.cloneNode(!0),p=u.querySelector(".popup__info-term"),_=u.querySelector(".popup__info-description");p&&_&&(p.textContent=d,_.textContent=y||"",o.infoModal.infoList.appendChild(u))};r("Название:",e.name||"Без названия"),e.createdAt&&r("Дата создания:",J(new Date(e.createdAt)));const i=e.owner&&e.owner.name?e.owner.name:"Неизвестно";r("Владелец:",i);const l=e.likes&&Array.isArray(e.likes)?e.likes.length:0;r("Количество лайков:",l),o.infoModal.text.textContent="Пользователи, поставившие лайк:",e.likes&&Array.isArray(e.likes)&&e.likes.forEach(d=>{const y=d.name||"Неизвестный пользователь",u=s.content.cloneNode(!0),p=u.querySelector(".popup__list-item");p&&(p.textContent=y,o.infoModal.userList.appendChild(u))}),v(o.modals.info)}catch(t){console.error("Ошибка при отображении информации о карточке:",t)}},profileFormSubmit:e=>{e.preventDefault();const t=e.submitter,s=t.textContent;t.textContent="Сохранение...",A({name:o.forms.profile.inputs.name.value,about:o.forms.profile.inputs.description.value}).then(r=>{o.profile.title.textContent=r.name,o.profile.description.textContent=r.about,m(o.forms.profile.modal),o.forms.profile.form.reset()}).catch(r=>{console.log("Ошибка при обновлении профиля:",r)}).finally(()=>{t.textContent=s})},avatarFormSubmit:e=>{e.preventDefault();const t=e.submitter,s=t.textContent;t.textContent="Сохранение...",I(o.forms.avatar.input.value).then(r=>{o.profile.avatar.style.backgroundImage=`url(${r.avatar})`,m(o.forms.avatar.modal),o.forms.avatar.form.reset()}).catch(r=>{console.log("Ошибка при обновлении аватара:",r)}).finally(()=>{t.textContent=s})},cardFormSubmit:e=>{e.preventDefault();const t=e.submitter,s=t.textContent;t.textContent="Создание...",B({name:o.forms.card.inputs.name.value,link:o.forms.card.inputs.link.value}).then(r=>{const i=b({name:r.name,link:r.link,likes:r.likes,id:r._id,owner:r.owner,ownerId:r.owner._id,isOwn:r.owner._id===S,currentUserId:S,createdAt:r.createdAt},{onPreviewPicture:a.previewPicture,onLikeIcon:a.handleLikeCard,onDeleteCard:a.prepareCardDelete,onInfoClick:a.handleCardInfo});o.placesWrap.prepend(i),m(o.forms.card.modal),o.forms.card.form.reset()}).catch(r=>{console.log("Ошибка при добавлении карточки:",r)}).finally(()=>{t.textContent=s})},openProfileForm:()=>{o.forms.profile.inputs.name.value=o.profile.title.textContent,o.forms.profile.inputs.description.value=o.profile.description.textContent,v(o.forms.profile.modal),h(o.forms.profile.form,n.validation)},openAvatarForm:()=>{o.forms.avatar.form.reset(),v(o.forms.avatar.modal),h(o.forms.avatar.form,n.validation)},openCardForm:()=>{o.forms.card.form.reset(),v(o.forms.card.modal),h(o.forms.card.form,n.validation)}},R=()=>{o.forms.profile.form.addEventListener("submit",a.profileFormSubmit),o.forms.card.form.addEventListener("submit",a.cardFormSubmit),o.forms.avatar.form.addEventListener("submit",a.avatarFormSubmit),o.forms.removeCard.form.addEventListener("submit",a.handleCardDelete),o.profile.editButton.addEventListener("click",a.openProfileForm),o.profile.avatar.addEventListener("click",a.openAvatarForm),o.profile.addButton.addEventListener("click",a.openCardForm),document.querySelectorAll(".popup").forEach(t=>{F(t)})},z=()=>{j(n.validation)},K=()=>{R(),z()};document.addEventListener("DOMContentLoaded",()=>{K(),Promise.all([E(),w()]).then(([e,t])=>{S=t._id,o.profile.title.textContent=t.name,o.profile.description.textContent=t.about,o.profile.avatar.style.backgroundImage=`url(${t.avatar})`,o.placesWrap.innerHTML="",e.forEach(s=>{const r=b({name:s.name,link:s.link,likes:s.likes,id:s._id,owner:s.owner,ownerId:s.owner._id,isOwn:s.owner._id===S,currentUserId:S,createdAt:s.createdAt},{onPreviewPicture:a.previewPicture,onLikeIcon:a.handleLikeCard,onDeleteCard:a.prepareCardDelete,onInfoClick:a.handleCardInfo});o.placesWrap.append(r)})}).catch(e=>{console.log("Ошибка при загрузке данных:",e)})});

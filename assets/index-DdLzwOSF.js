(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const p of l.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&n(p)}).observe(document,{childList:!0,subtree:!0});function o(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(i){if(i.ep)return;i.ep=!0;const l=o(i);fetch(i.href,l)}})();const c={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"bc4a52ed-4eb4-47b2-8325-b0e84b6ab8de","Content-Type":"application/json"}},_=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),M=()=>fetch(`${c.baseUrl}/users/me`,{headers:c.headers}).then(_),A=()=>fetch(`${c.baseUrl}/cards`,{headers:c.headers}).then(_),E=({name:e,about:t})=>fetch(`${c.baseUrl}/users/me`,{method:"PATCH",headers:c.headers,body:JSON.stringify({name:e,about:t})}).then(_),B=e=>fetch(`${c.baseUrl}/users/me/avatar`,{method:"PATCH",headers:c.headers,body:JSON.stringify({avatar:e})}).then(_),P=({name:e,link:t})=>fetch(`${c.baseUrl}/cards`,{method:"POST",headers:c.headers,body:JSON.stringify({name:e,link:t})}).then(_),O=e=>fetch(`${c.baseUrl}/cards/${e}`,{method:"DELETE",headers:c.headers}).then(_),T=(e,t)=>fetch(`${c.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:c.headers}).then(_),U=(e,t)=>{e.textContent=t.length},$=(e,t)=>e.some(o=>o._id===t),F=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),k=(e,{onPreviewPicture:t,onLikeIcon:o,onDeleteCard:n,onInfoClick:i})=>{const l=F(),p=l.querySelector(".card__like-button"),d=l.querySelector(".card__control-button_type_delete"),f=l.querySelector(".card__control-button_type_info"),u=l.querySelector(".card__image"),m=l.querySelector(".card__like-count"),C=l.querySelector(".card__title");return u.src=e.link,u.alt=e.name,C.textContent=e.name,e.id&&(l.dataset.cardId=e.id),e.likes&&m&&(m.textContent=e.likes.length),e.likes&&$(e.likes,e.currentUserId)&&p.classList.add("card__like-button_is-active"),e.isOwn===!1&&(d.style.display="none"),i||(f.style.display="none"),o&&e.id&&p.addEventListener("click",()=>o(p,e.id,m)),n&&e.isOwn!==!1&&e.id&&d.addEventListener("click",()=>n(l,e.id)),i&&e.id&&f.addEventListener("click",()=>i(l)),t&&u.addEventListener("click",()=>t({name:e.name,link:e.link})),l},w=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");y(t)}},v=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",w)},y=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",w)},N=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{y(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&y(e)})},b=(e,t,o,n)=>{const i=e.querySelector(`#${t.id}-error`);i&&(t.classList.add(n.inputErrorClass),i.textContent=o,i.classList.add(n.errorClass))},I=(e,t,o)=>{const n=e.querySelector(`#${t.id}-error`);n&&(t.classList.remove(o.inputErrorClass),n.textContent="",n.classList.remove(o.errorClass))},W=(e,t,o)=>{if(t.validity.valid)I(e,t,o);else if(t.validity.patternMismatch){const n=t.dataset.errorMessage||t.validationMessage;b(e,t,n,o)}else b(e,t,t.validationMessage,o)},H=e=>e.some(t=>!t.validity.valid),x=(e,t)=>{e&&(e.classList.add(t.inactiveButtonClass),e.disabled=!0)},J=(e,t)=>{e&&(e.classList.remove(t.inactiveButtonClass),e.disabled=!1)},g=(e,t,o)=>{H(e)?x(t,o):J(t,o)},V=(e,t)=>{const o=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);n&&(g(o,n,t),o.forEach(i=>{i.addEventListener("input",()=>{W(e,i,t),g(o,n,t)})}))},q=(e,t)=>{const o=Array.from(e.querySelectorAll(t.inputSelector)),n=e.querySelector(t.submitButtonSelector);o.forEach(i=>{I(e,i,t)}),n&&x(n,t)},j=e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach(o=>{V(o,e)})},s={validation:{formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},selectors:{placesWrap:".places__list",profile:{title:".profile__title",description:".profile__description",avatar:".profile__image",editButton:".profile__edit-button",addButton:".profile__add-button"},modals:{editProfile:".popup_type_edit",newCard:".popup_type_new-card",image:".popup_type_image",editAvatar:".popup_type_edit-avatar",removeCard:".popup_type_remove-card",info:".popup_type_info"},forms:{profile:".popup__form",card:".popup__form",avatar:".popup__form",removeCard:".popup__form"},inputs:{profile:{name:".popup__input_type_name",description:".popup__input_type_description"},card:{name:".popup__input_type_card-name",link:".popup__input_type_url"},avatar:".popup__input"},imageModal:{image:".popup__image",caption:".popup__caption"},infoModal:{title:".popup__title",infoList:".popup__info",text:".popup__text",userList:".popup__list"}}},r={placesWrap:document.querySelector(s.selectors.placesWrap),profile:{title:document.querySelector(s.selectors.profile.title),description:document.querySelector(s.selectors.profile.description),avatar:document.querySelector(s.selectors.profile.avatar),editButton:document.querySelector(s.selectors.profile.editButton),addButton:document.querySelector(s.selectors.profile.addButton)},modals:{editProfile:document.querySelector(s.selectors.modals.editProfile),newCard:document.querySelector(s.selectors.modals.newCard),image:document.querySelector(s.selectors.modals.image),editAvatar:document.querySelector(s.selectors.modals.editAvatar),removeCard:document.querySelector(s.selectors.modals.removeCard),info:document.querySelector(s.selectors.modals.info)},forms:{profile:{modal:document.querySelector(s.selectors.modals.editProfile),form:document.querySelector(s.selectors.modals.editProfile).querySelector(s.selectors.forms.profile),inputs:{name:document.querySelector(s.selectors.modals.editProfile).querySelector(s.selectors.inputs.profile.name),description:document.querySelector(s.selectors.modals.editProfile).querySelector(s.selectors.inputs.profile.description)}},card:{modal:document.querySelector(s.selectors.modals.newCard),form:document.querySelector(s.selectors.modals.newCard).querySelector(s.selectors.forms.card),inputs:{name:document.querySelector(s.selectors.modals.newCard).querySelector(s.selectors.inputs.card.name),link:document.querySelector(s.selectors.modals.newCard).querySelector(s.selectors.inputs.card.link)}},avatar:{modal:document.querySelector(s.selectors.modals.editAvatar),form:document.querySelector(s.selectors.modals.editAvatar).querySelector(s.selectors.forms.avatar),input:document.querySelector(s.selectors.modals.editAvatar).querySelector(s.selectors.inputs.avatar)},removeCard:{modal:document.querySelector(s.selectors.modals.removeCard),form:document.querySelector(s.selectors.modals.removeCard).querySelector(s.selectors.forms.removeCard),submitButton:document.querySelector(s.selectors.modals.removeCard).querySelector(s.selectors.forms.removeCard+" .popup__button")}},imageModal:{image:document.querySelector(s.selectors.modals.image).querySelector(s.selectors.imageModal.image),caption:document.querySelector(s.selectors.modals.image).querySelector(s.selectors.imageModal.caption)},infoModal:{title:document.querySelector(s.selectors.modals.info).querySelector(s.selectors.infoModal.title),infoList:document.querySelector(s.selectors.modals.info).querySelector(s.selectors.infoModal.infoList),text:document.querySelector(s.selectors.modals.info).querySelector(s.selectors.infoModal.text),userList:document.querySelector(s.selectors.modals.info).querySelector(s.selectors.infoModal.userList)}};let S="",h=null;const D=e=>e.toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"}),L=(e,t)=>{if(!e||!t)return;const o={name:t.name||"",link:t.link||"",likes:t.likes||[],owner:t.owner||{name:"Неизвестно",_id:""},createdAt:t.createdAt||new Date().toISOString(),id:t._id||t.id||"",ownerId:t.owner?._id||t.ownerId||"",currentUserId:S};e.dataset.cardInfo=JSON.stringify(o)},a={previewPicture:({name:e,link:t})=>{r.imageModal.image.src=t,r.imageModal.image.alt=e,r.imageModal.caption.textContent=e,v(r.modals.image)},handleLikeCard:(e,t,o)=>{const n=e.classList.contains("card__like-button_is-active");T(t,n).then(i=>{e.classList.toggle("card__like-button_is-active"),o&&U(o,i.likes);const l=e.closest(".card");l&&L(l,i)}).catch(i=>{console.log("Ошибка при изменении лайка:",i)})},prepareCardDelete:(e,t)=>{h={element:e,id:t},v(r.modals.removeCard)},handleCardDelete:e=>{e.preventDefault();const t=e.submitter||r.forms.removeCard.submitButton,o=t.textContent;t.textContent="Удаление...",O(h.id).then(()=>{h.element.remove(),y(r.modals.removeCard),h=null}).catch(n=>{console.log("Ошибка при удалении:",n)}).finally(()=>{t.textContent=o})},handleCardInfo:e=>{let t;if(e&&e.dataset.cardInfo)try{t=JSON.parse(e.dataset.cardInfo)}catch(o){console.error("Ошибка при парсинге данных карточки:",o);return}else{console.error("Нет данных карточки в DOM");return}if(!t||!t.name&&!t.id){console.error("Card data missing required fields:",t);return}try{if(!r.infoModal.title||!r.infoModal.infoList||!r.infoModal.userList||!r.infoModal.text){console.error("Не все DOM-элементы для информации о карточке найдены");return}r.infoModal.infoList.innerHTML="",r.infoModal.userList.innerHTML="",r.infoModal.title.textContent=t.name||"Без названия";const o=document.getElementById("popup-info-definition-template"),n=document.getElementById("popup-info-user-preview-template");if(!o||!n){console.error("Шаблоны для информации о карточке не найдены");return}const i=(d,f)=>{const u=o.content.cloneNode(!0),m=u.querySelector(".popup__info-term"),C=u.querySelector(".popup__info-description");m&&C&&(m.textContent=d,C.textContent=f!=null?String(f):"",r.infoModal.infoList.appendChild(u))};if(i("Название:",t.name||"Без названия"),t.createdAt)try{i("Дата создания:",D(new Date(t.createdAt)))}catch(d){console.error("Ошибка при форматировании даты:",d),i("Дата создания:","Неизвестно")}const l=t.owner&&t.owner.name?t.owner.name:"Неизвестно";i("Владелец:",l);const p=t.likes&&Array.isArray(t.likes)?t.likes.length:0;i("Количество лайков:",p),r.infoModal.text.textContent="Пользователи, поставившие лайк:",t.likes&&Array.isArray(t.likes)&&t.likes.forEach(d=>{const f=d&&d.name?d.name:"Неизвестный пользователь",u=n.content.cloneNode(!0),m=u.querySelector(".popup__list-item");m&&(m.textContent=f,r.infoModal.userList.appendChild(u))}),v(r.modals.info)}catch(o){console.error("Ошибка при отображении информации о карточке:",o)}},profileFormSubmit:e=>{e.preventDefault();const t=e.submitter,o=t.textContent;t.textContent="Сохранение...",E({name:r.forms.profile.inputs.name.value,about:r.forms.profile.inputs.description.value}).then(n=>{r.profile.title.textContent=n.name,r.profile.description.textContent=n.about,y(r.forms.profile.modal),r.forms.profile.form.reset()}).catch(n=>{console.log("Ошибка при обновлении профиля:",n)}).finally(()=>{t.textContent=o})},avatarFormSubmit:e=>{e.preventDefault();const t=e.submitter,o=t.textContent;t.textContent="Сохранение...",B(r.forms.avatar.input.value).then(n=>{r.profile.avatar.style.backgroundImage=`url(${n.avatar})`,y(r.forms.avatar.modal),r.forms.avatar.form.reset()}).catch(n=>{console.log("Ошибка при обновлении аватара:",n)}).finally(()=>{t.textContent=o})},cardFormSubmit:e=>{e.preventDefault();const t=e.submitter,o=t.textContent;t.textContent="Создание...",P({name:r.forms.card.inputs.name.value,link:r.forms.card.inputs.link.value}).then(n=>{const i=k({name:n.name,link:n.link,likes:n.likes,id:n._id,owner:n.owner,ownerId:n.owner._id,isOwn:n.owner._id===S,currentUserId:S,createdAt:n.createdAt},{onPreviewPicture:a.previewPicture,onLikeIcon:a.handleLikeCard,onDeleteCard:a.prepareCardDelete,onInfoClick:a.handleCardInfo});L(i,n),r.placesWrap.prepend(i),y(r.forms.card.modal),r.forms.card.form.reset()}).catch(n=>{console.log("Ошибка при добавлении карточки:",n)}).finally(()=>{t.textContent=o})},openProfileForm:()=>{r.forms.profile.inputs.name.value=r.profile.title.textContent,r.forms.profile.inputs.description.value=r.profile.description.textContent,v(r.forms.profile.modal),q(r.forms.profile.form,s.validation)},openAvatarForm:()=>{r.forms.avatar.form.reset(),v(r.forms.avatar.modal),q(r.forms.avatar.form,s.validation)},openCardForm:()=>{r.forms.card.form.reset(),v(r.forms.card.modal),q(r.forms.card.form,s.validation)}},R=()=>{r.forms.profile.form.addEventListener("submit",a.profileFormSubmit),r.forms.card.form.addEventListener("submit",a.cardFormSubmit),r.forms.avatar.form.addEventListener("submit",a.avatarFormSubmit),r.forms.removeCard.form.addEventListener("submit",a.handleCardDelete),r.profile.editButton.addEventListener("click",a.openProfileForm),r.profile.avatar.addEventListener("click",a.openAvatarForm),r.profile.addButton.addEventListener("click",a.openCardForm),document.querySelectorAll(".popup").forEach(t=>{N(t)})},z=()=>{j(s.validation)},K=()=>{R(),z()};document.addEventListener("DOMContentLoaded",()=>{K(),Promise.all([A(),M()]).then(([e,t])=>{S=t._id,r.profile.title.textContent=t.name,r.profile.description.textContent=t.about,r.profile.avatar.style.backgroundImage=`url(${t.avatar})`,r.placesWrap.innerHTML="",e.forEach(o=>{const n=k({name:o.name,link:o.link,likes:o.likes,id:o._id,owner:o.owner,ownerId:o.owner._id,isOwn:o.owner._id===S,currentUserId:S,createdAt:o.createdAt},{onPreviewPicture:a.previewPicture,onLikeIcon:a.handleLikeCard,onDeleteCard:a.prepareCardDelete,onInfoClick:a.handleCardInfo});L(n,o),r.placesWrap.append(n)})}).catch(e=>{console.log("Ошибка при загрузке данных:",e)})});

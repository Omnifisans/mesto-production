(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(s){if(s.ep)return;s.ep=!0;const l=n(s);fetch(s.href,l)}})();const d={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"bc4a52ed-4eb4-47b2-8325-b0e84b6ab8de","Content-Type":"application/json"}},_=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),E=()=>fetch(`${d.baseUrl}/users/me`,{headers:d.headers}).then(_),B=()=>fetch(`${d.baseUrl}/cards`,{headers:d.headers}).then(_),P=({name:e,about:t})=>fetch(`${d.baseUrl}/users/me`,{method:"PATCH",headers:d.headers,body:JSON.stringify({name:e,about:t})}).then(_),O=e=>fetch(`${d.baseUrl}/users/me/avatar`,{method:"PATCH",headers:d.headers,body:JSON.stringify({avatar:e})}).then(_),U=({name:e,link:t})=>fetch(`${d.baseUrl}/cards`,{method:"POST",headers:d.headers,body:JSON.stringify({name:e,link:t})}).then(_),T=e=>fetch(`${d.baseUrl}/cards/${e}`,{method:"DELETE",headers:d.headers}).then(_),N=(e,t)=>fetch(`${d.baseUrl}/cards/likes/${e}`,{method:t?"DELETE":"PUT",headers:d.headers}).then(_),$=(e,t)=>{e.textContent=t.length},F=(e,t)=>e.some(n=>n._id===t),J=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),I=(e,{onPreviewPicture:t,onLikeIcon:n,onDeleteCard:o,onInfoClick:s})=>{const l=J(),a=l.querySelector(".card__like-button"),m=l.querySelector(".card__control-button_type_delete"),u=l.querySelector(".card__control-button_type_info"),p=l.querySelector(".card__image"),v=l.querySelector(".card__like-count"),A=l.querySelector(".card__title");return p.src=e.link,p.alt=e.name,A.textContent=e.name,e.id&&(l.dataset.cardId=e.id),e.likes&&v&&(v.textContent=e.likes.length),e.likes&&F(e.likes,e.currentUserId)&&a.classList.add("card__like-button_is-active"),e.isOwn===!1&&(m.style.display="none"),s||(u.style.display="none"),n&&e.id&&a.addEventListener("click",()=>n(a,e.id,v)),o&&e.isOwn!==!1&&e.id&&m.addEventListener("click",()=>o(l,e.id)),s&&e.id&&u.addEventListener("click",()=>s(l)),t&&p.addEventListener("click",()=>t({name:e.name,link:e.link})),l},w=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");y(t)}},S=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",w)},y=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",w)},W=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{y(e)}),e.addEventListener("mousedown",n=>{n.target.classList.contains("popup")&&y(e)})},g=(e,t,n,o)=>{const s=e.querySelector(`#${t.id}-error`);s&&(t.classList.add(o.inputErrorClass),s.textContent=n,s.classList.add(o.errorClass))},M=(e,t,n)=>{const o=e.querySelector(`#${t.id}-error`);o&&(t.classList.remove(n.inputErrorClass),o.textContent="",o.classList.remove(n.errorClass))},H=(e,t,n)=>{if(t.validity.valid)M(e,t,n);else if(t.validity.patternMismatch){const o=t.dataset.errorMessage||t.validationMessage;g(e,t,o,n)}else g(e,t,t.validationMessage,n)},V=e=>e.some(t=>!t.validity.valid),x=(e,t)=>{e&&(e.classList.add(t.inactiveButtonClass),e.disabled=!0)},j=(e,t)=>{e&&(e.classList.remove(t.inactiveButtonClass),e.disabled=!1)},k=(e,t,n)=>{V(e)?x(t,n):j(t,n)},R=(e,t)=>{const n=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);o&&(k(n,o,t),n.forEach(s=>{s.addEventListener("input",()=>{H(e,s,t),k(n,o,t)})}))},h=(e,t)=>{const n=Array.from(e.querySelectorAll(t.inputSelector)),o=e.querySelector(t.submitButtonSelector);n.forEach(s=>{M(e,s,t)}),o&&x(o,t)},z=e=>{Array.from(document.querySelectorAll(e.formSelector)).forEach(n=>{R(n,e)})},i={validation:{formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},selectors:{placesWrap:".places__list",profile:{title:".profile__title",description:".profile__description",avatar:".profile__image",editButton:".profile__edit-button",addButton:".profile__add-button"},modals:{editProfile:".popup_type_edit",newCard:".popup_type_new-card",image:".popup_type_image",editAvatar:".popup_type_edit-avatar",removeCard:".popup_type_remove-card",info:".popup_type_info"},forms:{profile:".popup__form",card:".popup__form",avatar:".popup__form",removeCard:".popup__form"},inputs:{profile:{name:".popup__input_type_name",description:".popup__input_type_description"},card:{name:".popup__input_type_card-name",link:".popup__input_type_url"},avatar:".popup__input"},imageModal:{image:".popup__image",caption:".popup__caption"},infoModal:{title:".popup__title",infoList:".popup__info",text:".popup__text",userList:".popup__list"}}},r={placesWrap:document.querySelector(i.selectors.placesWrap),profile:{title:document.querySelector(i.selectors.profile.title),description:document.querySelector(i.selectors.profile.description),avatar:document.querySelector(i.selectors.profile.avatar),editButton:document.querySelector(i.selectors.profile.editButton),addButton:document.querySelector(i.selectors.profile.addButton)},modals:{editProfile:document.querySelector(i.selectors.modals.editProfile),newCard:document.querySelector(i.selectors.modals.newCard),image:document.querySelector(i.selectors.modals.image),editAvatar:document.querySelector(i.selectors.modals.editAvatar),removeCard:document.querySelector(i.selectors.modals.removeCard),info:document.querySelector(i.selectors.modals.info)},forms:{profile:{modal:document.querySelector(i.selectors.modals.editProfile),form:document.querySelector(i.selectors.modals.editProfile).querySelector(i.selectors.forms.profile),inputs:{name:document.querySelector(i.selectors.modals.editProfile).querySelector(i.selectors.inputs.profile.name),description:document.querySelector(i.selectors.modals.editProfile).querySelector(i.selectors.inputs.profile.description)}},card:{modal:document.querySelector(i.selectors.modals.newCard),form:document.querySelector(i.selectors.modals.newCard).querySelector(i.selectors.forms.card),inputs:{name:document.querySelector(i.selectors.modals.newCard).querySelector(i.selectors.inputs.card.name),link:document.querySelector(i.selectors.modals.newCard).querySelector(i.selectors.inputs.card.link)}},avatar:{modal:document.querySelector(i.selectors.modals.editAvatar),form:document.querySelector(i.selectors.modals.editAvatar).querySelector(i.selectors.forms.avatar),input:document.querySelector(i.selectors.modals.editAvatar).querySelector(i.selectors.inputs.avatar)},removeCard:{modal:document.querySelector(i.selectors.modals.removeCard),form:document.querySelector(i.selectors.modals.removeCard).querySelector(i.selectors.forms.removeCard),submitButton:document.querySelector(i.selectors.modals.removeCard).querySelector(i.selectors.forms.removeCard+" .popup__button")}},imageModal:{image:document.querySelector(i.selectors.modals.image).querySelector(i.selectors.imageModal.image),caption:document.querySelector(i.selectors.modals.image).querySelector(i.selectors.imageModal.caption)},infoModal:{title:document.querySelector(i.selectors.modals.info).querySelector(i.selectors.infoModal.title),infoList:document.querySelector(i.selectors.modals.info).querySelector(i.selectors.infoModal.infoList),text:document.querySelector(i.selectors.modals.info).querySelector(i.selectors.infoModal.text),userList:document.querySelector(i.selectors.modals.info).querySelector(i.selectors.infoModal.userList)}};let f="",C=null,q=null;const K=e=>e.toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"}),L=(e,t)=>{if(!e||!t)return;const n={name:t.name||"",link:t.link||"",likes:t.likes||[],owner:t.owner||{name:"Неизвестно",_id:""},createdAt:t.createdAt||new Date().toISOString(),id:t._id||t.id||"",ownerId:t.owner?._id||t.ownerId||"",currentUserId:f};return e.dataset.cardInfo=JSON.stringify(n),n},G=(e,t)=>{document.querySelectorAll(".card").forEach(o=>{if(o.dataset.cardInfo)try{const s=JSON.parse(o.dataset.cardInfo);let l=!1;s.likes&&Array.isArray(s.likes)&&s.likes.forEach(a=>{a._id===e&&(a.name=t,l=!0)}),s.owner&&s.owner._id===e&&(s.owner.name=t,l=!0),l&&(o.dataset.cardInfo=JSON.stringify(s)),q===o&&r.modals.info.classList.contains("popup_is-opened")&&b(s)}catch(s){console.error("Ошибка при обновлении имени пользователя в карточке:",s)}})},b=e=>{if(e)try{if(!r.infoModal.title||!r.infoModal.infoList||!r.infoModal.userList||!r.infoModal.text){console.error("Не все DOM-элементы для информации о карточке найдены");return}r.infoModal.infoList.innerHTML="",r.infoModal.userList.innerHTML="",r.infoModal.title.textContent=e.name||"Без названия";const t=document.getElementById("popup-info-definition-template"),n=document.getElementById("popup-info-user-preview-template");if(!t||!n){console.error("Шаблоны для информации о карточке не найдены");return}const o=(a,m)=>{const u=t.content.cloneNode(!0),p=u.querySelector(".popup__info-term"),v=u.querySelector(".popup__info-description");p&&v&&(p.textContent=a,v.textContent=m!=null?String(m):"",r.infoModal.infoList.appendChild(u))};if(o("Название:",e.name||"Без названия"),e.createdAt)try{o("Дата создания:",K(new Date(e.createdAt)))}catch(a){console.error("Ошибка при форматировании даты:",a),o("Дата создания:","Неизвестно")}const s=e.owner&&e.owner.name?e.owner.name:"Неизвестно";o("Владелец:",s);const l=e.likes&&Array.isArray(e.likes)?e.likes.length:0;o("Количество лайков:",l),r.infoModal.text.textContent="Пользователи, поставившие лайк:",e.likes&&Array.isArray(e.likes)&&e.likes.forEach(a=>{const m=a&&a.name?a.name:"Неизвестный пользователь",u=n.content.cloneNode(!0),p=u.querySelector(".popup__list-item");p&&(p.textContent=m,r.infoModal.userList.appendChild(u))})}catch(t){console.error("Ошибка при обновлении информации о карточке:",t)}},c={previewPicture:({name:e,link:t})=>{r.imageModal.image.src=t,r.imageModal.image.alt=e,r.imageModal.caption.textContent=e,S(r.modals.image)},handleLikeCard:(e,t,n)=>{const o=e.classList.contains("card__like-button_is-active");N(t,o).then(s=>{e.classList.toggle("card__like-button_is-active"),n&&$(n,s.likes);const l=e.closest(".card");if(l){const a=L(l,s);q===l&&r.modals.info.classList.contains("popup_is-opened")&&b(a)}}).catch(s=>{console.log("Ошибка при изменении лайка:",s)})},prepareCardDelete:(e,t)=>{C={element:e,id:t},S(r.modals.removeCard)},handleCardDelete:e=>{e.preventDefault();const t=e.submitter||r.forms.removeCard.submitButton,n=t.textContent;t.textContent="Удаление...",T(C.id).then(()=>{C.element.remove(),y(r.modals.removeCard),C=null}).catch(o=>{console.log("Ошибка при удалении:",o)}).finally(()=>{t.textContent=n})},handleCardInfo:e=>{q=e;let t;if(e&&e.dataset.cardInfo)try{t=JSON.parse(e.dataset.cardInfo)}catch(n){console.error("Ошибка при парсинге данных карточки:",n);return}else{console.error("Нет данных карточки в DOM");return}if(!t||!t.name&&!t.id){console.error("Card data missing required fields:",t);return}b(t),S(r.modals.info)},profileFormSubmit:e=>{e.preventDefault();const t=e.submitter,n=t.textContent;t.textContent="Сохранение...",P({name:r.forms.profile.inputs.name.value,about:r.forms.profile.inputs.description.value}).then(o=>{const s=o.name;r.profile.title.textContent=s,r.profile.description.textContent=o.about,f&&G(f,s),y(r.forms.profile.modal),r.forms.profile.form.reset()}).catch(o=>{console.log("Ошибка при обновлении профиля:",o)}).finally(()=>{t.textContent=n})},avatarFormSubmit:e=>{e.preventDefault();const t=e.submitter,n=t.textContent;t.textContent="Сохранение...",O(r.forms.avatar.input.value).then(o=>{r.profile.avatar.style.backgroundImage=`url(${o.avatar})`,y(r.forms.avatar.modal),r.forms.avatar.form.reset()}).catch(o=>{console.log("Ошибка при обновлении аватара:",o)}).finally(()=>{t.textContent=n})},cardFormSubmit:e=>{e.preventDefault();const t=e.submitter,n=t.textContent;t.textContent="Создание...",U({name:r.forms.card.inputs.name.value,link:r.forms.card.inputs.link.value}).then(o=>{const s=I({name:o.name,link:o.link,likes:o.likes,id:o._id,owner:o.owner,ownerId:o.owner._id,isOwn:o.owner._id===f,currentUserId:f,createdAt:o.createdAt},{onPreviewPicture:c.previewPicture,onLikeIcon:c.handleLikeCard,onDeleteCard:c.prepareCardDelete,onInfoClick:c.handleCardInfo});L(s,o),r.placesWrap.prepend(s),y(r.forms.card.modal),r.forms.card.form.reset()}).catch(o=>{console.log("Ошибка при добавлении карточки:",o)}).finally(()=>{t.textContent=n})},openProfileForm:()=>{r.forms.profile.inputs.name.value=r.profile.title.textContent,r.forms.profile.inputs.description.value=r.profile.description.textContent,S(r.forms.profile.modal),h(r.forms.profile.form,i.validation)},openAvatarForm:()=>{r.forms.avatar.form.reset(),S(r.forms.avatar.modal),h(r.forms.avatar.form,i.validation)},openCardForm:()=>{r.forms.card.form.reset(),S(r.forms.card.modal),h(r.forms.card.form,i.validation)}},Q=()=>{r.forms.profile.form.addEventListener("submit",c.profileFormSubmit),r.forms.card.form.addEventListener("submit",c.cardFormSubmit),r.forms.avatar.form.addEventListener("submit",c.avatarFormSubmit),r.forms.removeCard.form.addEventListener("submit",c.handleCardDelete),r.profile.editButton.addEventListener("click",c.openProfileForm),r.profile.avatar.addEventListener("click",c.openAvatarForm),r.profile.addButton.addEventListener("click",c.openCardForm),document.querySelectorAll(".popup").forEach(t=>{W(t)})},X=()=>{z(i.validation)},Y=()=>{Q(),X()};document.addEventListener("DOMContentLoaded",()=>{Y(),Promise.all([B(),E()]).then(([e,t])=>{f=t._id,t.name,r.profile.title.textContent=t.name,r.profile.description.textContent=t.about,r.profile.avatar.style.backgroundImage=`url(${t.avatar})`,r.placesWrap.innerHTML="",e.forEach(n=>{const o=I({name:n.name,link:n.link,likes:n.likes,id:n._id,owner:n.owner,ownerId:n.owner._id,isOwn:n.owner._id===f,currentUserId:f,createdAt:n.createdAt},{onPreviewPicture:c.previewPicture,onLikeIcon:c.handleLikeCard,onDeleteCard:c.prepareCardDelete,onInfoClick:c.handleCardInfo});L(o,n),r.placesWrap.append(o)})}).catch(e=>{console.log("Ошибка при загрузке данных:",e)})});
